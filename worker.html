<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Darbuotojo puslapis</title>
    </head>
    <body>
        <div id="filters"></div>
        <div id="clients"></div>
        <script src="scripts/init.js"></script>
        <script>
            const fields = [
                ['registracija', 'registracija'],
                ['isdavimas', 'išdavimas'],
                ['pratesimas', 'pratęsimas'],
                ['uzsakymas', 'užsakymas'],
            ].sort((a, b) => (a > b ? 1 : -1));
            document.getElementById('filters').innerHTML = fields
                .map(
                    e =>
                        `<label>${
                            e[1]
                        } <input type="checkbox" name="filters" value="${
                            e[0]
                        }" onchange="show()" /></label>`
                )
                .join(' ');
            function show() {
                loadStorage();
                let active = [...document.getElementsByName('filters')]
                    .filter(e => e.checked)
                    .map(e => e.value);
                let sorted = data
                    .filter(e => active.includes(e.subject))
                    .sort((a, b) => b.time - a.time)
                    .sort((a, b) => (a.subject > b.subject ? 1 : -1))
                    .map(
                        e =>
                            e.subject +
                            ' ' +
                            (e.id + '').padStart(3, '0') +
                            " <button onclick='serve(" +
                            JSON.stringify(e) +
                            ")'>Aptarnauta</button>"
                    );
                document.getElementById('clients').innerHTML = sorted.join(
                    '<br />'
                );
            }
            function serve(obj) {
                let predicate = (e, obj) =>
                    e.id === obj.id &&
                    e.subject === obj.subject &&
                    e.time === obj.time;
                let exists = data.filter(e => predicate(e, obj));
                if (exists.length == 0) {
                    return;
                }
                data = data.filter(e => !predicate(e, obj));
                localStorage.setItem(name, JSON.stringify(data));
                loadStorage();
                show();
            }
            setInterval(show, 5000);
        </script>
    </body>
</html>
