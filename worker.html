<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Darbuotojo puslapis</title>
    </head>
    <body>
        <div id="filters"></div>
        <div id="clients"></div>
        <script src="scripts/init.js"></script>
        <script>
            document.getElementById('filters').innerHTML = Object.keys(fields)
                .map(
                    e =>
                        `<label>${fields[e]} <input type="checkbox" name="filters" value="${e}" onchange="show()" /></label>`
                )
                .join(' ');
            function show() {
                loadStorage();
                let active = [...document.getElementsByName('filters')]
                    .filter(e => e.checked)
                    .map(e => e.value);
                let sorted = data
                    .filter(e => active.includes(e.subject) && e.served === 0)
                    .sort(
                        (a, b) =>
                            Math.max(b.register, b.posponed) -
                            Math.max(a.register, a.posponed)
                    )
                    .sort((a, b) => (a.subject > b.subject ? 1 : -1))
                    .map(
                        e =>
                            fields[e.subject] +
                            ' ' +
                            (e.id + '').padStart(3, '0') +
                            " <button onclick='serve(" +
                            e.unique +
                            ")'>Aptarnauta</button>"
                    );
                document.getElementById('clients').innerHTML = sorted.join(
                    '<br />'
                );
            }
            function serve(unique) {
                let predicate = e => e.unique === unique;
                let exists = data.findIndex(predicate);
                if (exists === -1) {
                    return;
                }
                data[exists].served = Date.now();
                localStorage.setItem(name, JSON.stringify(data));
                loadStorage();
                show();
            }
            setInterval(show, 5000);
        </script>
    </body>
</html>
