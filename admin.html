<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <title>Administravimas</title>
    </head>
    <body>
        <div id="filters"></div>
        <hr />
        <div>
            <button onclick="load().catch(wrong)">Užkrauti duomenis</button>
            <button onclick="remove()">Ištrinti duomenis</button>
            <div id="message"></div>
            <div>
                Esami duomenys
                <table id="data" border="1"></table>
            </div>
        </div>
        <script src="scripts/init.js"></script>
        <script>
            Object.keys(fields).forEach(key => {
                document.getElementById(
                    'filters'
                ).innerHTML += `<label><input type="radio" name="filter" value="${key}" /> ${fields[key]}</label><br />`;
            });
            document.getElementById(
                'filters'
            ).innerHTML += `<button onclick="submit()">Registruoti klientą</button>`;
            function submit() {
                let subject = null;
                document.getElementsByName('filter').forEach(e => {
                    if (e.checked) {
                        subject = e.value;
                        e.checked = false;
                    }
                });
                if (subject === null) {
                    document.getElementById('message').innerHTML =
                        'Nepasirinkta į kur užregistruoti';
                    return;
                }
                loadStorage();
                let last = data.sort((a, b) => b.id - a.id).map(e => e.id)[0];
                last = last === 999 || last === undefined ? 1 : last + 1;
                data.push(new Client(last, subject, Date.now()));
                localStorage.setItem('clients', JSON.stringify(data));
                document.getElementById('message').innerHTML =
                    'Užregistruota sėkmingai';
                update();
            }
            function timezone() {
                let timezone = new Date()
                    .toString()
                    .split('GMT')[1]
                    .split(' (')[0];
                let aH =
                    (timezone[1] + timezone[2]) * ((timezone[0] + '1') * 1);
                let aM =
                    (timezone[3] + timezone[4]) * ((timezone[0] + '1') * 1);
                return (aH * 60 + aM) * 1000 * 60;
            }
            function formattedTime(timestamp) {
                return new Date(timestamp)
                    .toISOString()
                    .split('.')[0]
                    .split('T')
                    .join('<br />');
            }
            function update() {
                let additional = timezone();
                loadStorage();
                data.sort((a, b) => b.register - a.register);
                document.getElementById('data').innerHTML =
                    data.length === 0
                        ? `<tr><th>Duomenų nėra</th></tr>`
                        : `<tr><th>ID</th><th>Užklausa</th><th>Registracija</th><th>Aptarnauta</th></tr>` +
                          data
                              .map(
                                  e =>
                                      `<tr><td>${e.id}</td><td>${
                                          fields[e.subject]
                                      }</td><td>${formattedTime(
                                          e.register + additional
                                      )}</td><td>${
                                          e.served === 0
                                              ? 'NE'
                                              : e.served === -1
                                              ? 'Atšaukta'
                                              : formattedTime(
                                                    e.served + additional
                                                )
                                      }</td>`
                              )
                              .join('');
            }
            async function load() {
                let input = await fetch('backend/clients.json');
                /**
                 *
                 * @type {Client[]}
                 */
                let json = await input.json();
                data = json.map(
                    e =>
                        new Client(
                            e.id,
                            e.subject,
                            e.register,
                            e.unique,
                            e.served
                        )
                );
                localStorage.setItem('clients', JSON.stringify(data));
                document.getElementById('message').innerHTML =
                    'Duomenys sėkmingai užkrauti';
                update();
            }
            function wrong() {
                document.getElementById('message').innerHTML =
                    'Nepavyko nuskaityti lankytojų duomenų';
                update();
            }
            function remove() {
                localStorage.removeItem(name);
                document.getElementById('message').innerHTML =
                    'Duomenys sėkmingai ištrinti';
                update();
            }
            update();
        </script>
    </body>
</html>
