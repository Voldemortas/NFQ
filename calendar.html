<!DOCTYPE html>
<html lang="lt">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
        />

        <title>Kalendorius</title>
        <style>
            table {
                margin-left: auto;
                margin-right: auto;
            }
            td {
                text-align: center;
                font-size: 18px;
                padding: 5px;
                border: 2px solid transparent;
            }
            #calendar td:hover {
                cursor: pointer;
            }
            #calendar .selected {
                border: 2px solid black;
            }
            .holiday {
                color: red;
            }
            .grey {
                color: grey;
            }
            aside {
                text-align: center;
            }
            main {
                text-align: center;
            }

            @media only screen and (min-width: 400px) {
                aside {
                    width: 300px;
                    float: left;
                    text-align: center;
                }
                main {
                    width: calc(100% - 320px);
                    float: right;
                }
            }
        </style>
    </head>
    <body>
        <aside>
            <div id="date">
                <hr />
                Pasirinkite datą
                <hr />
                <div id="calendar"></div>
                <i>*Raudonumas indikuoja užimtumą</i>
            </div>
            <hr />
            <div id="filters">
                Pasirinkite filtrus
                <hr />
                <div
                    style="text-align: left; margin-left: 10px"
                    id="generatedFilters"
                ></div>
            </div>
            <hr />
        </aside>
        <main id="mainContent"><hr /></main>
        <script src="scripts/init.js"></script>
        <script>
            loadStorage();
            {
                Object.keys(fields).forEach(key => {
                    document.getElementById(
                        'generatedFilters'
                    ).innerHTML += `<label><input type="checkbox" name="filter" checked value="${key}" onchange="wtf()" />
                                        ${fields[key]}</label><br />`;
                });
            }
            let selectedDay = {};
            function wtf() {
                let idk = [...document.getElementsByName('filter')]
                    .filter(e => e.checked)
                    .map(e => e.value);
                let chosen = [...document.getElementsByClassName('selected')];
                if (chosen.length === 0) {
                    selectedDay = rightNow();
                } else {
                    chosen = JSON.parse(chosen[0].dataset.day);
                    selectedDay = new Day(
                        chosen.year,
                        chosen.month,
                        chosen.day
                    );
                }
                let workingHours = [8, 9, 10, 11, 12, 14, 15, 16];
                function leadingZero(number) {
                    return (number + '').padStart(2, 0);
                }
                let clients = workingHours.map(e => {
                    let start = new Date(
                        selectedDay.year,
                        selectedDay.month,
                        selectedDay.day,
                        e
                    ).getTime();
                    let finish = new Date(
                        selectedDay.year,
                        selectedDay.month,
                        selectedDay.day,
                        e + 1
                    ).getTime();
                    console.log(start, finish);
                    return data.filter(
                        e => e.register > start && e.register <= finish
                    );
                });
                let cells = `<tr><td>Laikas</td><td>Klientai</td></tr>`;
                for (let i = 0; i < workingHours.length; i++) {
                    cells += `<tr><td>${leadingZero(
                        workingHours[i]
                    )}:00 ${leadingZero(workingHours[i] + 1)}:00</td><td>${
                        clients[i].length
                    }</td></tr>`;
                }
                document.getElementById(
                    'mainContent'
                ).innerHTML = `<table width="100%" border="1">${cells}</table>`;
            }
            /**
             * @property {number} year
             * @property {number} month
             * @property {Day} first – pirma mėnesio diena
             * @property {Day} last – paskutinė mėnesio diena
             */
            class Calendar {
                /**
                 * @constructor
                 * @param {number} year
                 * @param {number} month
                 */
                constructor(year, month) {
                    this.year = year;
                    this.month = month;
                    this.first = new Day(year, month, 1);
                    this.last = new Day(year, month + 1, 0);
                }

                /**
                 * Ar diena yra Nedarbo diena
                 * @param {Day} day
                 * @return {boolean}
                 */

                static holidays(day) {
                    return (
                        day.weekday === 5 || //šeštadienis
                        day.weekday === 6 || //sekmadienis
                        (day.month === 0 && day.day === 1) || //sausio 1
                        (day.month === 1 && day.day === 16) || //vasario 16
                        (day.month === 2 && day.day === 11) || //kovo 11
                        (day.month === 4 && day.day === 1) || //gegužės 1
                        (day.month === 5 && day.day === 24) || //birželio 24
                        (day.month === 6 && day.day === 6) || //liepos 6
                        (day.month === 7 && day.day === 15) || //rugpjūčio 15
                        (day.month === 10 && day.day === 1) || //lapkričio 1
                        (day.month === 11 && day.day === 24) || //gruodžio 24
                        (day.month === 11 && day.day === 25) || //gruodžio 25
                        (day.month === 11 && day.day === 26) //gruodžio 26
                    );
                }

                /**
                 * @param {Day} day
                 * @return {Calendar}
                 */
                static fromDay(day) {
                    return new Calendar(day.year, day.month);
                }

                static makeTable(
                    selected = null,
                    callback = () => {},
                    divId = 'calendar'
                ) {
                    if (selected === null) {
                        selected = rightNow();
                    }
                    let month = Calendar.fromDay(selected);
                    let text = `<table>
                            <tr>
                                <td colspan="7" id="year">${month.year}</td>
                            </tr>
                            <tr>
                                <td><button onclick='Calendar.makeTable(${JSON.stringify(
                                    month.first.previous()
                                )})'><</button></td>
                                <td colspan="5" id="month">${
                                    Calendar.monthNames[month.month]
                                }</td>
                                <td><button onclick='Calendar.makeTable(${JSON.stringify(
                                    month.last.next()
                                )})'>></button></td>
                            </tr>`;
                    text += Calendar.dayNames.reduce(
                        (a, b) => `${a}<td>${b}</td>`,
                        '<tr>'
                    );
                    let temp = '';
                    let day = -month.first.weekday + 1;
                    text += `</tr>`;
                    while (day <= month.last.day) {
                        temp = '';
                        for (let i = 0; i < 7; i++) {
                            let style = '';
                            let realDay = new Day(month.year, month.month, day);
                            if (day <= month.last.day && day > 0) {
                                let date_tag = ``;
                                if (realDay.equals(selected)) {
                                    date_tag = ` data-day='${JSON.stringify(
                                        realDay
                                    )}'`;
                                }
                                if (Calendar.holidays(realDay)) {
                                    style += realDay.equals(selected)
                                        ? ' class="holiday selected"'
                                        : ' class="holiday"';
                                } else {
                                    let usage =
                                        Math.floor(Math.random() * 16) * 16 - 1;
                                    style += realDay.equals(selected)
                                        ? ` class="selected" style="background-color: rgb(255, ${usage}, ${usage})"`
                                        : ` style="background-color: rgb(255, ${usage}, ${usage})"`;
                                }

                                temp += `<td${style}${date_tag} onclick='Calendar.makeTable(${JSON.stringify(
                                    realDay
                                )}, ${callback})'>${day}</td>`;
                            } else {
                                temp += `<td>&nbsp;</td>`;
                            }
                            day++;
                        }
                        text += `<tr>${temp}</tr>`;
                    }

                    document.getElementById(divId).innerHTML = text;
                    callback();
                }
                /**
                 * Mėnesio pavadinimai
                 * @type {string[]}
                 */
                static monthNames = [
                    'Sausis',
                    'Vasaris',
                    'Kovas',
                    'Balandis',
                    'Gegužė',
                    'Birželis',
                    'Liepa',
                    'Rugpjūtis',
                    'Rugsėjis',
                    'Spalis',
                    'Lapkritis',
                    'Gruodis',
                ];
                /**
                 * Savaitės dienų sutrumpinimai
                 * @type {string[]}
                 */
                static dayNames = ['Pr', 'An', 'Tr', 'Kt', 'Pn', 'Št', 'Sk'];
                /**
                 * Savaitės dienų pavadinimai
                 * @type {string[]}
                 */
                static weekDays = [
                    'Pirmadienis',
                    'Antradienis',
                    'Trečiadienis',
                    'Ketvirtadienis',
                    'Penktadienis',
                    'Šeštadienis',
                    'Sekmadienis',
                ];
            }

            /**
             * @property {number} year
             * @property {number} month
             * @property {number} day
             * @property {number} weekday
             */
            class Day {
                /**
                 * @constructor
                 * @param {number} year
                 * @param {number} month
                 * @param {number} day
                 */
                constructor(year, month, day) {
                    let date = new Date(year, month, day);
                    this.year = date.getFullYear();
                    this.month = date.getMonth();
                    this.day = date.getDate();
                    this.weekday = (date.getDay() + 6) % 7; //tebūnie pirmadienis 0 diena
                }
                /**
                 * Ankstesnė diena
                 * @returns {Day}
                 */
                previous() {
                    return new Day(this.year, this.month, this.day - 1);
                }
                /**
                 * Paskesnė diena
                 * @returns {Day}
                 */
                next() {
                    return new Day(this.year, this.month, this.day + 1);
                }

                /**
                 * patikrina ar sutampa dienos
                 * @param {Day} day
                 * @returns {boolean}
                 */
                equals(day) {
                    return (
                        day.year === this.year &&
                        day.month === this.month &&
                        day.day === this.day
                    );
                }

                /**
                 * boundaries of working hours
                 * @returns {[number, number]}
                 */
                boundaries() {
                    return [
                        new Date(this.year, this.month, this.day, 8).getTime(),
                        new Date(this.year, this.month, this.day, 17).getTime(),
                    ];
                }
            }
            /**
             *
             * @returns {Day}
             */
            function rightNow() {
                let now = new Date(Date.now());
                return new Day(
                    now.getFullYear(),
                    now.getMonth(),
                    now.getDate()
                );
            }
            Calendar.makeTable(rightNow(), () => wtf());
        </script>
    </body>
</html>
